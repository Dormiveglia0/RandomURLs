<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>链接融合器 Pro - Link Fuser Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #f59e0b; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #d97706; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .url-item:hover { background-color: #374151; }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <!-- 跳转逻辑 -->
    <script>
    (async function() {
        const hash = window.location.hash;
        if (!hash || hash.length < 2) {
            return;
        }
        
        const poolId = hash.substring(1);
        // 您需要将 'YOUR_WORKER_URL_HERE' 替换为您的 Cloudflare Worker URL
        const WORKER_URL = 'https://my-link-fuser-api.huangzhe321.workers.dev'; 

        // 优化检查逻辑，防止“全部替换”导致错误
        if (WORKER_URL.includes('YOUR_WORKER_URL_HERE')) {
            console.error("请先在跳转脚本中配置您的Worker URL!");
            return;
        }

        try {
            document.documentElement.style.display = 'none';
            const response = await fetch(`${WORKER_URL}/api/pools/${poolId}`);
            
            if (!response.ok) {
                throw new Error(`Pool not found or worker error.`);
            }

            const data = await response.json();

            if (!data.urls || data.urls.length === 0) return;

            let targetUrl;
            if (data.mode === 'random') {
                targetUrl = data.urls[Math.floor(Math.random() * data.urls.length)];
            } else { // sequential
                const storageKey = `sequentialIndex_${poolId}`;
                let currentIndex = parseInt(localStorage.getItem(storageKey) || '0', 10);
                targetUrl = data.urls[currentIndex % data.urls.length];
                localStorage.setItem(storageKey, (currentIndex + 1).toString());
            }

            if (targetUrl) {
                window.location.replace(targetUrl);
            }
        } catch (error) {
            console.error("跳转失败:", error);
            document.documentElement.style.display = '';
        }
    })();
    </script>
</head>
<body class="antialiased">

    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex flex-col items-center justify-center z-[200]" style="display: none;">
        <div class="loader"></div>
        <p class="text-white text-lg mt-4">正在加载...</p>
    </div>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">链接融合器 Pro</h1>
            <p class="text-lg text-gray-400">创建并管理多个链接池，生成固定的短链接。</p>
        </header>

        <main id="main-content" class="space-y-8" style="display: none;">
            <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-white mb-4">1. 链接池管理</h2>
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <select id="pool-selector" class="w-full sm:w-auto flex-grow bg-gray-700 text-white px-4 py-2.5 rounded-md border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"></select>
                    <div class="flex gap-2 sm:gap-4 flex-shrink-0">
                         <button id="new-pool-btn" class="btn btn-primary font-semibold px-4 py-2 rounded-md">新建</button>
                         <button id="rename-pool-btn" class="btn btn-secondary font-semibold px-4 py-2 rounded-md">重命名</button>
                         <button id="delete-pool-btn" class="btn btn-danger font-semibold px-4 py-2 rounded-md">删除</button>
                    </div>
                </div>
            </section>
            
            <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-white mb-4">2. 添加链接到当前池</h2>
                <form id="add-url-form" class="flex flex-col sm:flex-row gap-4">
                    <input type="url" id="url-input" placeholder="https://example.com/image.png" required class="flex-grow bg-gray-700 text-white px-4 py-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <button type="submit" class="btn btn-primary font-semibold px-6 py-2 rounded-md">添加</button>
                </form>
            </section>

            <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">链接列表 (<span id="url-count">0</span>)</h2>
                </div>
                <div id="url-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <p id="empty-state" class="text-gray-500">暂无链接，请在上方添加。</p>
                </div>
            </section>

            <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-white mb-4">3. 选择调取方式</h2>
                <div class="flex items-center space-x-8">
                    <label class="flex items-center cursor-pointer"><input type="radio" name="mode" value="random" class="h-5 w-5 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500"><span class="ml-3 text-lg text-white">随机</span></label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="mode" value="sequential" class="h-5 w-5 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500"><span class="ml-3 text-lg text-white">轮询</span></label>
                </div>
            </section>
            
            <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-white mb-4">4. 生成固定链接</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="fused-url" readonly placeholder="配置链接池后将在此生成" class="flex-grow bg-gray-900 text-gray-400 px-4 py-2 rounded-md border border-gray-600 cursor-not-allowed">
                    <button id="copy-btn" class="btn btn-primary font-semibold px-6 py-2 rounded-md" disabled>复制</button>
                </div>
                 <p class="mt-4 text-sm text-gray-500"><strong>说明：</strong>这是一个固定链接。数据已保存在云端，分享此链接即可实现跳转。</p>
            </section>
        </main>
         <div id="welcome-message" class="text-center p-8 bg-gray-800 rounded-xl flex flex-col items-center justify-center">
             <h2 class="text-2xl font-semibold text-white mb-4">欢迎使用链接融合器 Pro</h2>
             <p class="text-gray-400 mb-6">您还没有创建任何链接池。请创建一个来开始使用。</p>
             <button id="initial-create-btn" class="btn btn-primary font-semibold px-6 py-3 rounded-md text-lg">创建第一个链接池</button>
        </div>
    </div>
    
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-4">Modal Title</h3>
            <p id="modal-text" class="text-gray-400 mb-6"></p>
            <input type="text" id="modal-input" class="w-full bg-gray-700 text-white px-4 py-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition mb-6">
            <div class="flex justify-end gap-4">
                <button id="modal-cancel" class="btn bg-gray-600 hover:bg-gray-500 text-white font-semibold px-6 py-2 rounded-md">取消</button>
                <button id="modal-confirm" class="btn btn-primary font-semibold px-6 py-2 rounded-md">确认</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // --- 配置 ---
        // !!! 重要：请将 'YOUR_WORKER_URL_HERE' 替换为您的 Cloudflare Worker URL
        const WORKER_URL = 'https://my-link-fuser-api.huangzhe321.workers.dev';

        // --- 辅助函数 & API ---
        const showToast = (message, isError = false) => {
            const toastId = `toast-${Date.now()}`;
            const toast = document.createElement('div');
            toast.id = toastId;
            const bgColor = isError ? 'bg-red-500' : 'bg-green-500';
            toast.className = `w-full max-w-xs p-4 text-white rounded-lg shadow-lg ${bgColor} transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `<p>${message}</p>`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-x-full'); }, 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        const api = {
            async getPools() { return await this._request('GET', '/api/pools'); },
            async createPool(name) { return await this._request('POST', '/api/pools', { name }); },
            async updatePool(id, data) { return await this._request('PUT', `/api/pools/${id}`, data); },
            async deletePool(id) { return await this._request('DELETE', `/api/pools/${id}`); },
            async _request(method, path, body = null) {
                // 优化检查逻辑，防止“全部替换”导致错误
                if (WORKER_URL.includes('YOUR_WORKER_URL_HERE')) {
                    showToast('请先在JS代码中配置您的Worker URL!', true);
                    throw new Error("Worker URL not configured");
                }
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(WORKER_URL + path, options);
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(error.message);
                }
                if (response.status === 204) return null;
                return response.json();
            }
        };

        // --- UI & State Management ---
        const dom = {
            mainContent: document.getElementById('main-content'),
            welcomeMessage: document.getElementById('welcome-message'),
            initialCreateBtn: document.getElementById('initial-create-btn'),
            poolSelector: document.getElementById('pool-selector'),
            newPoolBtn: document.getElementById('new-pool-btn'),
            renamePoolBtn: document.getElementById('rename-pool-btn'),
            deletePoolBtn: document.getElementById('delete-pool-btn'),
            addUrlForm: document.getElementById('add-url-form'),
            urlInput: document.getElementById('url-input'),
            urlListDiv: document.getElementById('url-list'),
            urlCountSpan: document.getElementById('url-count'),
            modeRadios: document.querySelectorAll('input[name="mode"]'),
            fusedUrlInput: document.getElementById('fused-url'),
            copyBtn: document.getElementById('copy-btn'),
            emptyState: document.getElementById('empty-state'),
            loadingOverlay: document.getElementById('loading-overlay'),
            modal: {
                el: document.getElementById('modal'),
                title: document.getElementById('modal-title'),
                text: document.getElementById('modal-text'),
                input: document.getElementById('modal-input'),
                confirmBtn: document.getElementById('modal-confirm'),
                cancelBtn: document.getElementById('modal-cancel'),
            }
        };
        
        let appState = { pools: {}, activePoolId: null };
        let onModalConfirm = null;

        const showLoading = (show) => {
            dom.loadingOverlay.style.display = show ? 'flex' : 'none';
        };

        const showModal = ({ title, text = '', inputVisible = true, placeholder = '', inputValue = '', confirmText = '确认' }) => {
            dom.modal.title.textContent = title;
            dom.modal.text.textContent = text;
            dom.modal.text.style.display = text ? 'block' : 'none';
            dom.modal.input.style.display = inputVisible ? 'block' : 'none';
            dom.modal.input.placeholder = placeholder;
            dom.modal.input.value = inputValue;
            dom.modal.confirmBtn.textContent = confirmText;
            dom.modal.el.style.display = 'flex';
            if (inputVisible) setTimeout(() => dom.modal.input.focus(), 50);
        };
        
        const hideModal = () => {
            dom.modal.el.style.display = 'none';
            onModalConfirm = null;
        };
        
        const generateFusedUrl = () => {
            if (appState.activePoolId) {
                const baseUrl = window.location.href.split('#')[0];
                dom.fusedUrlInput.value = `${baseUrl}#${appState.activePoolId}`;
                dom.copyBtn.disabled = false;
            } else {
                dom.fusedUrlInput.value = '';
                dom.copyBtn.disabled = true;
            }
        };
        
        const render = () => {
            const hasPools = Object.keys(appState.pools).length > 0;
            dom.mainContent.style.display = hasPools ? 'block' : 'none';
            dom.welcomeMessage.style.display = hasPools ? 'none' : 'flex';
            
            if (!hasPools) {
                 generateFusedUrl();
                 return;
            }
            
            dom.poolSelector.innerHTML = '';
            Object.keys(appState.pools).forEach(id => {
                const pool = appState.pools[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = pool.name;
                if (id === appState.activePoolId) option.selected = true;
                dom.poolSelector.appendChild(option);
            });

            const pool = appState.activePoolId ? appState.pools[appState.activePoolId] : null;
            if (!pool) {
                 const firstPoolId = Object.keys(appState.pools)[0];
                 if (firstPoolId) appState.activePoolId = firstPoolId;
                 render();
                 return;
            }

            document.querySelector(`input[name="mode"][value="${pool.mode}"]`).checked = true;
            dom.urlListDiv.innerHTML = '';
            if (pool.urls.length === 0) {
                dom.urlListDiv.appendChild(dom.emptyState);
                dom.emptyState.style.display = 'block';
            } else {
                dom.emptyState.style.display = 'none';
                pool.urls.forEach((url, index) => {
                    const div = document.createElement('div');
                    div.className = 'url-item flex items-center justify-between bg-gray-700 p-3 rounded-md transition-all';
                    div.innerHTML = `<p class="text-gray-300 truncate mr-4" title="${url}">${url}</p>
                                     <button data-index="${index}" class="btn-delete-url btn btn-danger text-sm font-medium px-3 py-1 rounded-md flex-shrink-0">删除</button>`;
                    dom.urlListDiv.appendChild(div);
                });
            }
            dom.urlCountSpan.textContent = pool.urls.length;

            const manageButtonsDisabled = !appState.activePoolId;
            [dom.renamePoolBtn, dom.deletePoolBtn].forEach(btn => {
                btn.disabled = manageButtonsDisabled;
                btn.classList.toggle('disabled-btn', manageButtonsDisabled);
            });

            generateFusedUrl();
        };

        const init = async () => {
            showLoading(true);
            try {
                const poolsList = await api.getPools();
                appState.pools = poolsList.reduce((acc, pool) => {
                    acc[pool.id] = pool;
                    return acc;
                }, {});
                
                const savedActiveId = localStorage.getItem('linkFuserActivePool');
                if (savedActiveId && appState.pools[savedActiveId]) {
                    appState.activePoolId = savedActiveId;
                } else {
                    appState.activePoolId = poolsList.length > 0 ? poolsList[0].id : null;
                }
                
                render();
            } catch (e) {
                showToast(`加载数据失败: ${e.message}`, true);
            } finally {
                showLoading(false);
            }
        };

        // Event Listeners
        dom.initialCreateBtn.addEventListener('click', () => {
            showModal({ title: '创建新链接池', placeholder: '例如：我的图床' });
            onModalConfirm = async (value) => {
                if (value && value.trim()) {
                    showLoading(true);
                    hideModal();
                    try {
                        const newPool = await api.createPool(value.trim());
                        appState.pools[newPool.id] = newPool;
                        appState.activePoolId = newPool.id;
                        localStorage.setItem('linkFuserActivePool', newPool.id);
                        render();
                    } catch (e) {
                        showToast(`创建失败: ${e.message}`, true);
                    } finally {
                        showLoading(false);
                    }
                }
            };
        });
        dom.newPoolBtn.addEventListener('click', () => dom.initialCreateBtn.click());

        dom.renamePoolBtn.addEventListener('click', () => {
            const pool = appState.pools[appState.activePoolId];
            if (!pool) return;
            showModal({ title: '重命名链接池', placeholder: '输入新名称', inputValue: pool.name });
            onModalConfirm = async (value) => {
                if (value && value.trim() && value.trim() !== pool.name) {
                    showLoading(true);
                    hideModal();
                    try {
                        const updatedPool = { ...pool, name: value.trim() };
                        await api.updatePool(pool.id, updatedPool);
                        appState.pools[pool.id] = updatedPool;
                        render();
                    } catch(e) {
                        showToast(`重命名失败: ${e.message}`, true);
                    } finally {
                        showLoading(false);
                    }
                } else {
                    hideModal();
                }
            };
        });

        dom.deletePoolBtn.addEventListener('click', () => {
            const pool = appState.pools[appState.activePoolId];
            if (!pool) return;
            showModal({ title: `删除链接池 "${pool.name}"`, text: '此操作不可恢复。您确定要继续吗？', inputVisible: false, confirmText: '确认删除' });
            onModalConfirm = async () => {
                showLoading(true);
                hideModal();
                try {
                    await api.deletePool(pool.id);
                    delete appState.pools[pool.id];
                    const remainingIds = Object.keys(appState.pools);
                    appState.activePoolId = remainingIds.length > 0 ? remainingIds[0] : null;
                    localStorage.setItem('linkFuserActivePool', appState.activePoolId);
                    render();
                } catch(e) {
                    showToast(`删除失败: ${e.message}`, true);
                } finally {
                    showLoading(false);
                }
            };
        });

        dom.poolSelector.addEventListener('change', (e) => {
            appState.activePoolId = e.target.value;
            localStorage.setItem('linkFuserActivePool', appState.activePoolId);
            render();
        });
        
        dom.addUrlForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pool = appState.pools[appState.activePoolId];
            if (!pool) return;
            const newUrl = dom.urlInput.value.trim();
            if (newUrl) {
                try {
                    new URL(newUrl);
                    if (!pool.urls.includes(newUrl)) {
                       const updatedUrls = [...pool.urls, newUrl];
                       showLoading(true);
                       await api.updatePool(pool.id, { ...pool, urls: updatedUrls });
                       pool.urls = updatedUrls;
                       showLoading(false);
                       render();
                       showToast('链接添加成功！');
                    } else {
                       showToast('该链接已存在于池中。', true);
                    }
                    dom.urlInput.value = '';
                } catch (_) {
                   showToast('请输入有效的URL链接。', true);
                }
            }
        });
        
        dom.urlListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-delete-url')) {
                const pool = appState.pools[appState.activePoolId];
                const index = parseInt(e.target.dataset.index, 10);
                if (pool && !isNaN(index)) {
                    const updatedUrls = pool.urls.filter((_, i) => i !== index);
                    showLoading(true);
                    await api.updatePool(pool.id, { ...pool, urls: updatedUrls });
                    pool.urls = updatedUrls;
                    showLoading(false);
                    render();
                }
            }
        });

        dom.modeRadios.forEach(radio => radio.addEventListener('change', async (e) => {
            const pool = appState.pools[appState.activePoolId];
            if (pool && pool.mode !== e.target.value) {
                showLoading(true);
                await api.updatePool(pool.id, { ...pool, mode: e.target.value });
                pool.mode = e.target.value;
                showLoading(false);
            }
        }));
        
        dom.copyBtn.addEventListener('click', () => {
            if (!dom.fusedUrlInput.value) return;
            navigator.clipboard.writeText(dom.fusedUrlInput.value).then(() => {
                const originalText = dom.copyBtn.textContent;
                dom.copyBtn.textContent = '已复制!';
                dom.copyBtn.classList.remove('btn-primary');
                dom.copyBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    dom.copyBtn.textContent = originalText;
                    dom.copyBtn.classList.add('btn-primary');
                    dom.copyBtn.classList.remove('bg-green-600');
                }, 2000);
            });
        });

        dom.modal.cancelBtn.addEventListener('click', hideModal);
        dom.modal.confirmBtn.addEventListener('click', () => {
            if (typeof onModalConfirm === 'function') onModalConfirm(dom.modal.input.value);
        });
        dom.modal.input.addEventListener('keydown', (e) => {
             if (e.key === 'Enter') dom.modal.confirmBtn.click();
        });

        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>

